name: Deploy to OSS

on:
  workflow_run:
    workflows: ["Optimize resource pack"] 
    types:
      - completed

jobs:
  upload:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Download latest released pack
        uses: dsaltares/fetch-gh-release-asset@1.1.1
        with:
          file: pack.zip
          target: pack.zip
      - name: Rename pack file
        run: mv pack.zip pack-${{ github.run_number }}.zip
      - name: Install ossutil
        run: |
          curl -O http://gosspublic.alicdn.com/ossutil/1.7.0/ossutil64
          chmod 755 ossutil64
          mv ossutil64 /usr/local/bin/ossutil
  
      - name: Config ossutil
        run: |
          ossutil config -e ${{ secrets.OSS_ENDPOINT }} -i ${{ secrets.ALIYUN_ACCESS_KEY_ID }} -k ${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}
  
      - name: Upload files to OSS
        run: |
          ossutil cp -r pack-${{ github.run_number }}.zip oss://${{ secrets.OSS_BUCKET }}/assets/ --update
  
